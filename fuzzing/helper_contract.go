package fuzzing

import (
	"encoding/hex"
	"fmt"
	"math/big"
	"strings"

	"github.com/crytic/medusa-geth/accounts/abi"
	"github.com/crytic/medusa-geth/common"
	"github.com/crytic/medusa/chain"
	"github.com/holiman/uint256"

	"github.com/crytic/medusa/fuzzing/calls"
	"github.com/crytic/medusa/fuzzing/config"
	fuzzerTypes "github.com/crytic/medusa/fuzzing/contracts"
	fuzzingTypes "github.com/crytic/medusa/fuzzing/contracts"
	"github.com/crytic/medusa/fuzzing/executiontracer"

	coreTypes "github.com/crytic/medusa-geth/core/types"

	compilationTypes "github.com/crytic/medusa/compilation/types"
)

var FuzzHelperContract *fuzzingTypes.Contract

var FuzzHelperContractBytecode string = "608060405260405161177038038061177083398181016040528101906100259190610621565b3360015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610074816102e460201b60201c565b610097731820a4b7618bde71dce8cdc73aab6c95905fad2461045560201b60201c565b156102de575f731820a4b7618bde71dce8cdc73aab6c95905fad2490508073ffffffffffffffffffffffffffffffffffffffff166329965a1d307f29ddb589b1fb5fc7cf394961c1adf5f8c6454761adf795e67fe149f658abe895306040518463ffffffff1660e01b81526004016101119392919061068f565b5f604051808303815f87803b158015610128575f5ffd5b505af115801561013a573d5f5f3e3d5ffd5b505050508073ffffffffffffffffffffffffffffffffffffffff166329965a1d307fb281fc8c12954d22544db45de3159a39272895b169a852b314f9cc762e44c53b306040518463ffffffff1660e01b815260040161019b9392919061068f565b5f604051808303815f87803b1580156101b2575f5ffd5b505af11580156101c4573d5f5f3e3d5ffd5b505050508073ffffffffffffffffffffffffffffffffffffffff166329965a1d307faea199e31a596269b42cdafd93407f14436db6e4cad65417994c2eb37381e05a306040518463ffffffff1660e01b81526004016102259392919061068f565b5f604051808303815f87803b15801561023c575f5ffd5b505af115801561024e573d5f5f3e3d5ffd5b505050508073ffffffffffffffffffffffffffffffffffffffff166329965a1d307fac7fbab5f54a3ca8194167523c6753bfeb96a445279294b6125b68cce2177054306040518463ffffffff1660e01b81526004016102af9392919061068f565b5f604051808303815f87803b1580156102c6575f5ffd5b505af11580156102d8573d5f5f3e3d5ffd5b50505050505b50610798565b5f5f90505b8151811015610451575f828281518110610306576103056106c4565b5b602002602001015190505f5f90505b835181101561044257838181518110610331576103306106c4565b5b602002602001015173ffffffffffffffffffffffffffffffffffffffff1663095ea7b360e01b837fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff60405160240161038a929190610709565b604051602081830303815290604052907bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516103f49190610782565b5f604051808303815f865af19150503d805f811461042d576040519150601f19603f3d011682016040523d82523d5f602084013e610432565b606091505b5050508080600101915050610315565b505080806001019150506102e9565b5050565b5f5f823b90505f8111915050919050565b5f604051905090565b5f5ffd5b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6104c18261047b565b810181811067ffffffffffffffff821117156104e0576104df61048b565b5b80604052505050565b5f6104f2610466565b90506104fe82826104b8565b919050565b5f67ffffffffffffffff82111561051d5761051c61048b565b5b602082029050602081019050919050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61055b82610532565b9050919050565b61056b81610551565b8114610575575f5ffd5b50565b5f8151905061058681610562565b92915050565b5f61059e61059984610503565b6104e9565b905080838252602082019050602084028301858111156105c1576105c061052e565b5b835b818110156105ea57806105d68882610578565b8452602084019350506020810190506105c3565b5050509392505050565b5f82601f83011261060857610607610477565b5b815161061884826020860161058c565b91505092915050565b5f602082840312156106365761063561046f565b5b5f82015167ffffffffffffffff81111561065357610652610473565b5b61065f848285016105f4565b91505092915050565b61067181610551565b82525050565b5f819050919050565b61068981610677565b82525050565b5f6060820190506106a25f830186610668565b6106af6020830185610680565b6106bc6040830184610668565b949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f819050919050565b610703816106f1565b82525050565b5f60408201905061071c5f830185610668565b61072960208301846106fa565b9392505050565b5f81519050919050565b5f81905092915050565b8281835e5f83830152505050565b5f61075c82610730565b610766818561073a565b9350610776818560208601610744565b80840191505092915050565b5f61078d8284610752565b915081905092915050565b610fcb806107a55f395ff3fe608060405260043610610042575f3560e01c80630a0059b4146103455780638da5cb5b1461036f578063e2dbeef414610399578063f743dfc3146103c957610043565b5b5f73ffffffffffffffffffffffffffffffffffffffff1660025f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141580156100f157503373ffffffffffffffffffffffffffffffffffffffff1660025f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614155b610343575f60e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191660025f0160149054906101000a900460e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916141580156101c357505f365f9060049261016593929190610644565b9061017091906106bf565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191660025f0160149054906101000a900460e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614155b610343575f60065f9054906101000a900461ffff1661ffff161161034357600160065f8282829054906101000a900461ffff166102009190610757565b92506101000a81548161ffff021916908361ffff1602179055505f60026001015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166002800154600260030160405161026d9190610885565b5f6040518083038185875af1925050503d805f81146102a7576040519150601f19603f3d011682016040523d82523d5f602084013e6102ac565b606091505b50509050806102f0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102e7906108f5565b60405180910390fd5b600160065f8282829054906101000a900461ffff1661030f9190610913565b92506101000a81548161ffff021916908361ffff16021790555060015f5f82825461033a9190610951565b92505081905550505b005b348015610350575f5ffd5b506103596103f1565b6040516103669190610993565b60405180910390f35b34801561037a575f5ffd5b506103836103f6565b60405161039091906109eb565b60405180910390f35b6103b360048036038101906103ae9190610b72565b61041b565b6040516103c09190610be6565b60405180910390f35b3480156103d4575f5ffd5b506103ef60048036038101906103ea9190610c53565b6104d0565b005b5f5481565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f5f8373ffffffffffffffffffffffffffffffffffffffff1634846040516104439190610d2e565b5f6040518083038185875af1925050503d805f811461047d576040519150601f19603f3d011682016040523d82523d5f602084013e610482565b606091505b50509050806104c6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104bd906108f5565b60405180910390fd5b8091505092915050565b6040518060a001604052808373ffffffffffffffffffffffffffffffffffffffff168152602001827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526020018673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020018481525060025f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151815f0160146101000a81548163ffffffff021916908360e01c02179055506040820151816001015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506060820151816002015560808201518160030190816106109190610ec6565b5090505060015f5f8282546106259190610951565b925050819055505050505050565b5f604051905090565b5f5ffd5b5f5ffd5b5f5f858511156106575761065661063c565b5b8386111561066857610667610640565b5b6001850283019150848603905094509492505050565b5f82905092915050565b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b5f82821b905092915050565b5f6106ca838361067e565b826106d58135610688565b92506004821015610715576107107fffffffff00000000000000000000000000000000000000000000000000000000836004036008026106b3565b831692505b505092915050565b5f61ffff82169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6107618261071d565b915061076c8361071d565b9250828201905061ffff8111156107865761078561072a565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806107d057607f821691505b6020821081036107e3576107e261078c565b5b50919050565b5f81905092915050565b5f819050815f5260205f209050919050565b5f8154610811816107b9565b61081b81866107e9565b9450600182165f8114610835576001811461084a5761087c565b60ff198316865281151582028601935061087c565b610853856107f3565b5f5b8381101561087457815481890152600182019150602081019050610855565b838801955050505b50505092915050565b5f6108908284610805565b915081905092915050565b5f82825260208201905092915050565b7f72657665727420636f6e74726163742063616c6c0000000000000000000000005f82015250565b5f6108df60148361089b565b91506108ea826108ab565b602082019050919050565b5f6020820190508181035f83015261090c816108d3565b9050919050565b5f61091d8261071d565b91506109288361071d565b9250828203905061ffff8111156109425761094161072a565b5b92915050565b5f819050919050565b5f61095b82610948565b915061096683610948565b925082820190508082111561097e5761097d61072a565b5b92915050565b61098d81610948565b82525050565b5f6020820190506109a65f830184610984565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6109d5826109ac565b9050919050565b6109e5816109cb565b82525050565b5f6020820190506109fe5f8301846109dc565b92915050565b5f5ffd5b5f5ffd5b610a15816109cb565b8114610a1f575f5ffd5b50565b5f81359050610a3081610a0c565b92915050565b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610a8482610a3e565b810181811067ffffffffffffffff82111715610aa357610aa2610a4e565b5b80604052505050565b5f610ab5610633565b9050610ac18282610a7b565b919050565b5f67ffffffffffffffff821115610ae057610adf610a4e565b5b610ae982610a3e565b9050602081019050919050565b828183375f83830152505050565b5f610b16610b1184610ac6565b610aac565b905082815260208101848484011115610b3257610b31610a3a565b5b610b3d848285610af6565b509392505050565b5f82601f830112610b5957610b58610a36565b5b8135610b69848260208601610b04565b91505092915050565b5f5f60408385031215610b8857610b87610a04565b5b5f610b9585828601610a22565b925050602083013567ffffffffffffffff811115610bb657610bb5610a08565b5b610bc285828601610b45565b9150509250929050565b5f8115159050919050565b610be081610bcc565b82525050565b5f602082019050610bf95f830184610bd7565b92915050565b610c0881610948565b8114610c12575f5ffd5b50565b5f81359050610c2381610bff565b92915050565b610c3281610688565b8114610c3c575f5ffd5b50565b5f81359050610c4d81610c29565b92915050565b5f5f5f5f5f60a08688031215610c6c57610c6b610a04565b5b5f610c7988828901610a22565b9550506020610c8a88828901610c15565b945050604086013567ffffffffffffffff811115610cab57610caa610a08565b5b610cb788828901610b45565b9350506060610cc888828901610a22565b9250506080610cd988828901610c3f565b9150509295509295909350565b5f81519050919050565b8281835e5f83830152505050565b5f610d0882610ce6565b610d1281856107e9565b9350610d22818560208601610cf0565b80840191505092915050565b5f610d398284610cfe565b915081905092915050565b5f6020601f8301049050919050565b5f60088302610d827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826106b3565b610d8c86836106b3565b95508019841693508086168417925050509392505050565b5f819050919050565b5f610dc7610dc2610dbd84610948565b610da4565b610948565b9050919050565b5f819050919050565b610de083610dad565b610df4610dec82610dce565b848454610d53565b825550505050565b5f5f905090565b610e0b610dfc565b610e16818484610dd7565b505050565b5b81811015610e3957610e2e5f82610e03565b600181019050610e1c565b5050565b601f821115610e7e57610e4f816107f3565b610e5884610d44565b81016020851015610e67578190505b610e7b610e7385610d44565b830182610e1b565b50505b505050565b5f82821c905092915050565b5f610e9e5f1984600802610e83565b1980831691505092915050565b5f610eb68383610e8f565b9150826002028217905092915050565b610ecf82610ce6565b67ffffffffffffffff811115610ee857610ee7610a4e565b5b610ef282546107b9565b610efd828285610e3d565b5f60209050601f831160018114610f2e575f8415610f1c578287015190505b610f268582610eab565b865550610f8d565b601f198416610f3c866107f3565b5f5b82811015610f6357848901518255600182019150602085019450602081019050610f3e565b86831015610f805784890151610f7c601f891682610e8f565b8355505b6001600288020188555050505b50505050505056fea264697066735822122076d4d892caf818ac9a7b922150dedd011b837ceb932d8b82934f51e32df8624264736f6c634300081c0033"
var FuzzHelperContractDeployedBytecode string = "608060405260043610610042575f3560e01c80630a0059b4146103455780638da5cb5b1461036f578063e2dbeef414610399578063f743dfc3146103c957610043565b5b5f73ffffffffffffffffffffffffffffffffffffffff1660025f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141580156100f157503373ffffffffffffffffffffffffffffffffffffffff1660025f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614155b610343575f60e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191660025f0160149054906101000a900460e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916141580156101c357505f365f9060049261016593929190610644565b9061017091906106bf565b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191660025f0160149054906101000a900460e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614155b610343575f60065f9054906101000a900461ffff1661ffff161161034357600160065f8282829054906101000a900461ffff166102009190610757565b92506101000a81548161ffff021916908361ffff1602179055505f60026001015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166002800154600260030160405161026d9190610885565b5f6040518083038185875af1925050503d805f81146102a7576040519150601f19603f3d011682016040523d82523d5f602084013e6102ac565b606091505b50509050806102f0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102e7906108f5565b60405180910390fd5b600160065f8282829054906101000a900461ffff1661030f9190610913565b92506101000a81548161ffff021916908361ffff16021790555060015f5f82825461033a9190610951565b92505081905550505b005b348015610350575f5ffd5b506103596103f1565b6040516103669190610993565b60405180910390f35b34801561037a575f5ffd5b506103836103f6565b60405161039091906109eb565b60405180910390f35b6103b360048036038101906103ae9190610b72565b61041b565b6040516103c09190610be6565b60405180910390f35b3480156103d4575f5ffd5b506103ef60048036038101906103ea9190610c53565b6104d0565b005b5f5481565b60015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f5f8373ffffffffffffffffffffffffffffffffffffffff1634846040516104439190610d2e565b5f6040518083038185875af1925050503d805f811461047d576040519150601f19603f3d011682016040523d82523d5f602084013e610482565b606091505b50509050806104c6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104bd906108f5565b60405180910390fd5b8091505092915050565b6040518060a001604052808373ffffffffffffffffffffffffffffffffffffffff168152602001827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526020018673ffffffffffffffffffffffffffffffffffffffff1681526020018581526020018481525060025f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151815f0160146101000a81548163ffffffff021916908360e01c02179055506040820151816001015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506060820151816002015560808201518160030190816106109190610ec6565b5090505060015f5f8282546106259190610951565b925050819055505050505050565b5f604051905090565b5f5ffd5b5f5ffd5b5f5f858511156106575761065661063c565b5b8386111561066857610667610640565b5b6001850283019150848603905094509492505050565b5f82905092915050565b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b5f82821b905092915050565b5f6106ca838361067e565b826106d58135610688565b92506004821015610715576107107fffffffff00000000000000000000000000000000000000000000000000000000836004036008026106b3565b831692505b505092915050565b5f61ffff82169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6107618261071d565b915061076c8361071d565b9250828201905061ffff8111156107865761078561072a565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806107d057607f821691505b6020821081036107e3576107e261078c565b5b50919050565b5f81905092915050565b5f819050815f5260205f209050919050565b5f8154610811816107b9565b61081b81866107e9565b9450600182165f8114610835576001811461084a5761087c565b60ff198316865281151582028601935061087c565b610853856107f3565b5f5b8381101561087457815481890152600182019150602081019050610855565b838801955050505b50505092915050565b5f6108908284610805565b915081905092915050565b5f82825260208201905092915050565b7f72657665727420636f6e74726163742063616c6c0000000000000000000000005f82015250565b5f6108df60148361089b565b91506108ea826108ab565b602082019050919050565b5f6020820190508181035f83015261090c816108d3565b9050919050565b5f61091d8261071d565b91506109288361071d565b9250828203905061ffff8111156109425761094161072a565b5b92915050565b5f819050919050565b5f61095b82610948565b915061096683610948565b925082820190508082111561097e5761097d61072a565b5b92915050565b61098d81610948565b82525050565b5f6020820190506109a65f830184610984565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6109d5826109ac565b9050919050565b6109e5816109cb565b82525050565b5f6020820190506109fe5f8301846109dc565b92915050565b5f5ffd5b5f5ffd5b610a15816109cb565b8114610a1f575f5ffd5b50565b5f81359050610a3081610a0c565b92915050565b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610a8482610a3e565b810181811067ffffffffffffffff82111715610aa357610aa2610a4e565b5b80604052505050565b5f610ab5610633565b9050610ac18282610a7b565b919050565b5f67ffffffffffffffff821115610ae057610adf610a4e565b5b610ae982610a3e565b9050602081019050919050565b828183375f83830152505050565b5f610b16610b1184610ac6565b610aac565b905082815260208101848484011115610b3257610b31610a3a565b5b610b3d848285610af6565b509392505050565b5f82601f830112610b5957610b58610a36565b5b8135610b69848260208601610b04565b91505092915050565b5f5f60408385031215610b8857610b87610a04565b5b5f610b9585828601610a22565b925050602083013567ffffffffffffffff811115610bb657610bb5610a08565b5b610bc285828601610b45565b9150509250929050565b5f8115159050919050565b610be081610bcc565b82525050565b5f602082019050610bf95f830184610bd7565b92915050565b610c0881610948565b8114610c12575f5ffd5b50565b5f81359050610c2381610bff565b92915050565b610c3281610688565b8114610c3c575f5ffd5b50565b5f81359050610c4d81610c29565b92915050565b5f5f5f5f5f60a08688031215610c6c57610c6b610a04565b5b5f610c7988828901610a22565b9550506020610c8a88828901610c15565b945050604086013567ffffffffffffffff811115610cab57610caa610a08565b5b610cb788828901610b45565b9350506060610cc888828901610a22565b9250506080610cd988828901610c3f565b9150509295509295909350565b5f81519050919050565b8281835e5f83830152505050565b5f610d0882610ce6565b610d1281856107e9565b9350610d22818560208601610cf0565b80840191505092915050565b5f610d398284610cfe565b915081905092915050565b5f6020601f8301049050919050565b5f60088302610d827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826106b3565b610d8c86836106b3565b95508019841693508086168417925050509392505050565b5f819050919050565b5f610dc7610dc2610dbd84610948565b610da4565b610948565b9050919050565b5f819050919050565b610de083610dad565b610df4610dec82610dce565b848454610d53565b825550505050565b5f5f905090565b610e0b610dfc565b610e16818484610dd7565b505050565b5b81811015610e3957610e2e5f82610e03565b600181019050610e1c565b5050565b601f821115610e7e57610e4f816107f3565b610e5884610d44565b81016020851015610e67578190505b610e7b610e7385610d44565b830182610e1b565b50505b505050565b5f82821c905092915050565b5f610e9e5f1984600802610e83565b1980831691505092915050565b5f610eb68383610e8f565b9150826002028217905092915050565b610ecf82610ce6565b67ffffffffffffffff811115610ee857610ee7610a4e565b5b610ef282546107b9565b610efd828285610e3d565b5f60209050601f831160018114610f2e575f8415610f1c578287015190505b610f268582610eab565b865550610f8d565b601f198416610f3c866107f3565b5f5b82811015610f6357848901518255600182019150602085019450602081019050610f3e565b86831015610f805784890151610f7c601f891682610e8f565b8355505b6001600288020188555050505b50505050505056fea264697066735822122076d4d892caf818ac9a7b922150dedd011b837ceb932d8b82934f51e32df8624264736f6c634300081c0033"

var FuzzHelperContractAddress common.Address

var FuzzHelperContractAbiString string = `
[
	{
		"type": "constructor",
		"inputs": [
			{
				"name": "targetAddresses",
				"type": "address[]",
				"internalType": "address[]"
			}
		],
		"stateMutability": "payable"
	},
	{
		"type": "fallback",
		"stateMutability": "payable"
	},
	{
		"type": "function",
		"name": "internalCallFlag",
		"inputs": [],
		"outputs": [
			{
				"name": "",
				"type": "bool",
				"internalType": "bool"
			}
		],
		"stateMutability": "view"
	},
	{
		"type": "function",
		"name": "owner",
		"inputs": [],
		"outputs": [
			{
				"name": "",
				"type": "address",
				"internalType": "address"
			}
		],
		"stateMutability": "view"
	},
	{
		"type": "function",
		"name": "sendMsgUtil",
		"inputs": [
			{
				"name": "to",
				"type": "address",
				"internalType": "address"
			},
			{
				"name": "data",
				"type": "bytes",
				"internalType": "bytes"
			}
		],
		"outputs": [
			{
				"name": "",
				"type": "bool",
				"internalType": "bool"
			}
		],
		"stateMutability": "payable"
	},
	{
		"type": "function",
		"name": "setInternalCallback",
		"inputs": [
			{
				"name": "t",
				"type": "address",
				"internalType": "address"
			},
			{
				"name": "v",
				"type": "uint256",
				"internalType": "uint256"
			},
			{
				"name": "p",
				"type": "bytes",
				"internalType": "bytes"
			},
			{
				"name": "f",
				"type": "address",
				"internalType": "address"
			},
			{
				"name": "s",
				"type": "bytes4",
				"internalType": "bytes4"
			}
		],
		"outputs": [],
		"stateMutability": "nonpayable"
	}
]
`

func init() {
	// init FuzzHelperContract
	fuzzHelperAbi, err := abi.JSON(strings.NewReader(FuzzHelperContractAbiString))
	if err != nil {
		fmt.Println("Parser error", err)
	}

	fuzzHelperBytecode, _ := hex.DecodeString(FuzzHelperContractBytecode)
	fuzzHelperDeployedBytecode, _ := hex.DecodeString(FuzzHelperContractDeployedBytecode)
	FuzzHelperContract = fuzzingTypes.NewContract("FuzzHelperContract", "", &compilationTypes.CompiledContract{
		Abi:             fuzzHelperAbi,
		InitBytecode:    fuzzHelperBytecode,
		RuntimeBytecode: fuzzHelperDeployedBytecode,
	}, nil)
}

func setupFuzzHelperContract(fuzzer *Fuzzer, testChain *chain.TestChain) (*executiontracer.ExecutionTrace, error, common.Address) {
	contractName := "FuzzHelperContract"
	helperContractAddress := common.Address{}
	// deploy helperContract
	args := make([]any, 0)
	var addressList []common.Address
	if fuzzer.isOnChainTarget {
		for _, targetAddress := range fuzzer.config.Fuzzing.TargetContracts {
			addressList = append(addressList, common.HexToAddress(targetAddress))
		}
	}

	args = append(args, addressList)
	msgData, err := FuzzHelperContract.CompiledContract().GetDeploymentMessageData(args)
	if err != nil {
		return nil, fmt.Errorf("initial contract deployment failed for contract \"%v\", error: %v", FuzzHelperContract.Name(), err), helperContractAddress
	}

	sedner := common.HexToAddress(fuzzer.config.Fuzzing.SenderAddresses[0])
	contractBalance := big.NewInt(0)
	senderBalance := testChain.State().GetBalance(sedner)
	if senderBalance.Cmp(uint256.NewInt(0)) > 0 {
		contractBalance = new(uint256.Int).Div(senderBalance, uint256.NewInt(2)).ToBig()
	}

	msg := calls.NewCallMessage(fuzzer.senders[0], nil, 0, contractBalance, blockGasLimit, nil, nil, nil, msgData)
	msg.FillFromTestChainProperties(testChain)

	block, err := testChain.PendingBlockCreate()
	if err != nil {
		return nil, err, helperContractAddress
	}
	err = testChain.PendingBlockAddTx(msg.ToCoreMessage())
	if err != nil {
		return nil, err, helperContractAddress
	}

	err = testChain.PendingBlockCommit()
	if err != nil {
		return nil, err, helperContractAddress
	}

	// Ensure our transaction succeeded and, if it did not, attach an execution trace to it and re-run it.
	// The execution trace will be returned so that it can be provided to the user for debugging
	if block.MessageResults[0].Receipt.Status != coreTypes.ReceiptStatusSuccessful {
		// Create a call sequence element to represent the failed contract deployment tx
		cse := calls.NewCallSequenceElement(nil, msg, 0, 0)
		cse.ChainReference = &calls.CallSequenceElementChainReference{
			Block:            block,
			TransactionIndex: len(block.Messages) - 1,
		}
		// Revert to one block before and re-run the failed contract deployment tx.
		// This should be one index before the current head block index.
		// We should be able to attach an execution trace; however, if it fails, we provide the ExecutionResult at a minimum.
		err = testChain.RevertToBlockIndex(uint64(len(testChain.CommittedBlocks()) - 1))
		if err != nil {
			return nil, fmt.Errorf("failed to reset to genesis block: %v", err), helperContractAddress
		} else {
			_, err = calls.ExecuteCallSequenceWithExecutionTracer(testChain, fuzzer.contractDefinitions, []*calls.CallSequenceElement{cse}, config.VeryVeryVerbose)
			if err != nil {
				return nil, fmt.Errorf("deploying %s returned a failed status: %v", contractName, block.MessageResults[0].ExecutionResult.Err), helperContractAddress
			}
		}

		// Return the execution error and the execution trace, if possible.
		return cse.ExecutionTrace, fmt.Errorf("deploying %s returned a failed status: %v", contractName, block.MessageResults[0].ExecutionResult.Err), helperContractAddress
	}

	FuzzHelperContractAddress = block.MessageResults[0].Receipt.ContractAddress

	fuzzer.contractDefinitions = append(fuzzer.contractDefinitions, fuzzerTypes.NewContract("FuzzHelper", "FuzzHelper", FuzzHelperContract.CompiledContract(), nil))
	return nil, nil, block.MessageResults[0].Receipt.ContractAddress
}

func ConvertToContractCall(element *calls.CallSequenceElement) (*calls.CallSequenceElement, error) {

	call := element.Call
	to := *call.To

	method := FuzzHelperContract.CompiledContract().Abi.Methods["sendMsgUtil"]
	abiData := &calls.CallMessageDataAbiValues{
		Method:      &method,
		InputValues: []any{to, call.Data},
	}

	element.Contract = FuzzHelperContract

	element.Call = calls.NewCallMessageWithAbiValueData(call.From, &FuzzHelperContractAddress, 0, call.Value, call.GasLimit, call.GasPrice, call.GasFeeCap, call.GasTipCap, abiData)

	return element, nil
}

func ConvertToInternalCall(element *calls.CallSequenceElement) (*calls.CallSequenceElement, error) {
	call := element.Call
	to := *call.To

	method := FuzzHelperContract.CompiledContract().Abi.Methods["setInternalCallback"]
	abiData := &calls.CallMessageDataAbiValues{
		Method:      &method,
		InputValues: []any{to, call.Value, call.Data, common.HexToAddress("0x0"), [4]byte{0, 0, 0, 0}},
	}

	element.Call = calls.NewCallMessageWithAbiValueData(
		call.From,
		&FuzzHelperContractAddress,
		0,
		call.Value,
		call.GasLimit,
		call.GasPrice,
		call.GasFeeCap,
		call.GasTipCap,
		abiData,
	)

	return element, nil
}
